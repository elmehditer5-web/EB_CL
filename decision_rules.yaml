# Decision Tree Rules for PM Extension Processing
# Author: Optimized version of Axel Lantin's decision tree
# Date: 2025-10-29

# Global configuration
config:
  date_pilot_swap: "2025-12-01"
  
# Priority rules based on occupation and weeks before alarm
priority_rules:
  - condition: "occupation >= 90"
    priority: 1
  - condition: "nb_sem_avant_al >= 0 and nb_sem_avant_al/4 <= 3"
    priority: 2
  - condition: "nb_sem_avant_al >= 0 and nb_sem_avant_al/4 <= 6"
    priority: 3
  - default: 4

# Pre-conditions that short-circuit the decision tree
pre_conditions:
  - condition: "multiple_PON == True"
    comment: "a envoyer a TAFi_Methodes pb : multiple_PON"
    return: true

# Main decision tree based on PON value
decision_tree:
  PON_16:
    comment: "a envoyer a TAFi_Methodes pb : PON16"
    
  PON_32:
    ZMD_AMII_ASTERIX:
      nb_lien_1:
        before_date_swap:
          check: "SWAP"
          success:
            comment: "A lancer en SWAP 1v32 vers 1v64"
            actions: "Swap 1v32 vers 1v64"
        after_date_swap:
          check: "fo"
          success:
            actions: "ajout 1 fo 1v32"
            nb_fibre_add: 1
            
      nb_lien_2:
        check: "SWAP"
        success:
          comment: "A lancer en SWAP des 2 liaisons 1v32 vers 1v64"
          actions: "Swap 1v32 vers 1v64"
          
      nb_lien_gt2:
        before_date_swap:
          odd_links:
            check: "fo"
            success:
              actions: "ajout 1 fo 1v32"
              nb_fibre_add: 1
          even_links:
            check: "fo"
            success:
              actions: "ajout 2 fo 1v32"
              nb_fibre_add: 2
        after_date_swap_le4:
          check: "SWAP"
          success:
            comment: "A lancer en SWAP de toutes les liaisons  1v32 vers 1v64"
            actions: "Swap 1v32 vers 1v64"
        after_date_swap_gt4:
          odd_links:
            check: "fo"
            success:
              actions: "ajout 1 fo 1v32"
              nb_fibre_add: 1
          even_links:
            check: "fo"
            success:
              actions: "ajout 2 fo 1v32"
              nb_fibre_add: 2
              
    ZMD_AMII_SFR_Orange:
      PM_300:
        nb_lien_1:
          before_date_swap:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
          after_date_swap:
            check: "fo"
            success:
              actions: "ajout 1 fo 1v32"
              nb_fibre_add: 1
              
        nb_lien_2:
          before_date_swap:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP des 2 liaisons  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
          after_date_swap:
            check: "fo"
            success:
              actions: "ajout 1 fo 1v32"
              nb_fibre_add: 1
              
        nb_lien_3:
          before_date_swap:
            comment: "a envoyer chez TAFi_Methode"
          after_date_swap_eligible:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP des 3 liaisons  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
          after_date_swap_not_eligible:
            check: "fo"
            success:
              actions: "ajout 1 fo 1v32"
              nb_fibre_add: 1
              
        nb_lien_4:
          before_date_swap:
            comment: "pas de solution : 4 liens nro_pm, PM300, ZMD AMII SFR/Orange, PON32"
          after_date_swap:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP des 4 liaisons  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
              
      PM_900:
        nb_lien_1:
          comment: "erreur : PM == 900 + nb_lien_nro_PM == 1"
          
        nb_lien_2:
          before_date_swap:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP des 2 liaisons  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
          after_date_swap:
            check: "fo"
            success:
              actions: "ajout 1 fo 1v32"
              nb_fibre_add: 1
              
        nb_lien_3_4:
          comment: "a envoyer chez TAFi_Methode"
          
        nb_lien_gt4:
          check: "fo"
          success:
            actions: "ajout 2 fo 1v32"
            nb_fibre_add: 2
            
      PM_1000:
        nb_lien_1:
          comment: "erreur : PM == 900 + nb_lien_nro_PM == 1"
          
        nb_lien_2:
          before_date_swap:
            check: "fo"
            success:
              actions: "ajout 1 fo 1v32"
              nb_fibre_add: 1
          after_date_swap:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP des 2 liaisons  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
              
        nb_lien_3:
          before_date_swap:
            check: "fo"
            success:
              actions: "ajout 3 fo 1v32"
              nb_fibre_add: 3
          after_date_swap:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP des 3 liaisons  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
              
        nb_lien_4:
          before_date_swap:
            check: "fo"
            success:
              actions: "ajout 2 fo 1v32"
              nb_fibre_add: 2
          after_date_swap:
            check: "SWAP"
            success:
              comment: "A lancer en SWAP des 4 liaisons  1v32 vers 1v64"
              actions: "Swap 1v32 vers 1v64"
              
        nb_lien_5:
          check: "fo"
          success:
            actions: "ajout 1 fo 1v32"
            nb_fibre_add: 1
            
        nb_lien_6:
          check: "fo"
          success:
            actions: "ajout 3 fo 1v32"
            nb_fibre_add: 3
            
        nb_lien_8:
          check: "fo"
          success:
            actions: "ajout 1 fo 1v32"
            nb_fibre_add: 1
            
        nb_lien_other:
          comment: "a envoyer chez TAFi_Methode"
          
    RIP_Altitude:
      check: "fo"
      success:
        actions: "ajout 1 fo 1v32"
        nb_fibre_add: 1
        
    Other_Partners:
      even_links:
        check: "fo"
        success:
          actions: "ajout 2 fo 1v32"
          nb_fibre_add: 2
      odd_links:
        check: "fo"
        success:
          actions: "ajout 1 fo 1v32"
          nb_fibre_add: 1
          
  PON_64:
    ZMD_AMII_SFR_Orange:
      PM_300:
        check: "fo"
        success:
          actions: "ajout 1 fo 1v64"
          nb_fibre_add: 1
          
      PM_900:
        fibre_waiting:
          check: "fo"
          success:
            actions: "ajout 1 fo 1v64"
            nb_fibre_add: 1
        no_fibre_waiting:
          check: "fo"
          success:
            actions: "ajout 2 fo 1v64"
            nb_fibre_add: 2
            
      PM_1000:
        fibre_waiting:
          check: "fo"
          success:
            actions: "ajout 1 fo 1v64"
            nb_fibre_add: 1
        no_fibre_waiting:
          check: "fo"
          success:
            actions: "ajout 3 fo 1v64"
            nb_fibre_add: 3
            
    ZMD_AMII_ASTERIX:
      sfp_eligible_ini:
        nb_lien_1:
          check: "SWAP"
          success:
            comment: "A lancer en SWAP de liaison 1v64 vers 1v128"
            actions: "Swap 1v64 vers 1v128"
        nb_lien_gt1:
          check: "SWAP"
          success:
            comment: "A lancer en SWAP de liaison 1v64 vers 1v128 et ajout de tiroir 64"
            actions: "Swap 1v64 vers 1v128 + ajout 1 tiroir 64"
      sfp_eligible_other_or_not_eligible:
        check: "fo"
        success:
          actions: "ajout 1 fo 1v64"
          nb_fibre_add: 1
          
    Other_Partners:
      check: "fo"
      success:
        actions: "ajout 1 fo 1v64"
        nb_fibre_add: 1
        
  PON_128:
    check: "fo"
    success:
      actions: "ajout 1 fo 1v128"
      nb_fibre_add: 1

# Details modification checks
detail_checks:
  OSS_NOK:
    condition: "capa_increase == 'OSS - NOK'"
    return: "OSS - NOK : voir pourquoi ça ne remonte pas dans les bases"
    
  VDR_EN_COURS:
    condition: "etat_last_projet == 'EN COURS'"
    return: "ne pas lancer, VDR en cours"
    
  SWAP_JAKARTA:
    condition: "operation == 'SWAP' and not pd.isna(date_jakarta) and etat_jakarta == 'Planifié' and date_jakarta >= date_limit"
    return: "ne pas lancer, JAKARTA"
    
  PORT_CHECKS:
    sufficient_ports:
      condition: "Ports_dispo_ff >= nb_pm_occup_sup_75"
      return: "pas de pb"
      
    need_nro_extension:
      condition: "Ports_dispo_ff > rang_nro"
      return: "lancer extension + extension nro"
      
    insufficient_ports:
      condition: "Ports_dispo_ff <= rang_nro or Ports_dispo_ff == 0"
      return: "lancer extension sur nro, on ne lance pas l'extension"
      set_field: "Ports_nro_suffisant"
      set_value: "non"

# Fibre waiting calculation rules
fibre_waiting_rules:
  PM_900:
    condition: "nb_lien_nro_PM % 2 == 0"
    result: true
  PM_1000:
    condition: "nb_lien_nro_PM % 3 == 0"
    result: true
  default: false
